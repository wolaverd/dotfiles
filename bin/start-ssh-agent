#!/usr/bin/env bash -e
umask 066

function start_agent {
	# Write ssh-agent startup vars to disk.
	ssh-agent | sed 's/^echo/#echo/' > "$ssh_environment"
	source "$ssh_environment" > /dev/null
}

ssh_environment="${HOME}/.ssh/environment"

# Export environment and start agent.
if [[ -f $ssh_environment ]]; then
	source "$ssh_environment" > /dev/null
	ps -p "$SSH_AGENT_PID" > /dev/null || start_agent
else
	start_agent
fi

if [[ -n $SSH_AGENT_PID && -f ${HOME}/.ssh/id_rsa ]]; then
	ssh-add "${HOME}/.ssh/id_rsa"
fi
